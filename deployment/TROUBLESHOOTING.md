# دليل استكشاف أخطاء النشر على cPanel وإصلاحها

هذا الدليل سيساعدك في حل مشكلة الخطأ 500 (Internal Server Error) التي قد تظهر عند نشر تطبيق Jaberco على cPanel.

## الخطوة 1: التحقق من إعدادات البيئة

1. قم بتسجيل الدخول إلى لوحة تحكم cPanel
2. انتقل إلى "Setup Node.js App"
3. حدد تطبيقك Jaberco
4. تأكد من تعيين المتغيرات البيئية التالية:
   - `NODE_ENV`: production
   - `PORT`: (اترك هذا كما هو، يتم تعيينه تلقائياً)
   - `DATABASE_URL`: (تأكد من أنه يشير إلى قاعدة البيانات الصحيحة)
   - `CLOUDINARY_CLOUD_NAME`: dsviwqpmy
   - `CLOUDINARY_API_KEY`: (المفتاح الخاص بك)
   - `CLOUDINARY_API_SECRET`: (السر الخاص بك)
   - `STRIPE_SECRET_KEY`: (المفتاح السري الخاص بك)
   - `VITE_STRIPE_PUBLIC_KEY`: (المفتاح العام الخاص بك)

## الخطوة 2: تشغيل سكربت التشخيص

1. افتح "Terminal" في cPanel أو اتصل بالخادم عبر SSH
2. انتقل إلى مجلد التطبيق:
   ```
   cd /path/to/your/app
   ```
3. قم بتشغيل سكربت التشخيص:
   ```
   node fix-cpanel.js
   ```
4. راجع المخرجات وتأكد من:
   - وجود جميع المجلدات والملفات الضرورية
   - تعيين متغيرات البيئة بشكل صحيح

## الخطوة 3: التحقق من اتصال قاعدة البيانات

1. قم بتثبيت وحدة postgres:
   ```
   npm install postgres --save
   ```
2. قم بتشغيل سكربت اختبار قاعدة البيانات:
   ```
   node test-db-connection.js
   ```
3. إذا ظهرت أخطاء في الاتصال، تأكد من:
   - صحة متغير البيئة DATABASE_URL
   - إنشاء قاعدة البيانات في cPanel
   - منح المستخدم الصلاحيات المناسبة

## الخطوة 4: استخدام وسيط HTTP لحل مشكلة توجيه الطلبات

إذا استمرت مشكلة الخطأ 500، فقد تكون بسبب مشكلة في توجيه طلبات API. يمكنك استخدام سكربت الوسيط:

1. تحقق من ملف .htaccess وتأكد من أنه يستخدم المنفذ الصحيح
2. قم بتشغيل سكربت الوسيط:
   ```
   node proxy-handler.js &
   ```
3. قم بتعديل ملف .htaccess لتوجيه طلبات API إلى الوسيط:
   ```
   # تعديل قاعدة API لاستخدام الوسيط
   RewriteRule ^api(/.*)?$ http://localhost:8080/api$1 [P,L]
   ```
4. أعد تشغيل التطبيق من لوحة تحكم cPanel

## الخطوة 5: ضبط إعدادات PM2 لإدارة التطبيق

1. قم بتثبيت PM2 عالمياً على الخادم:
   ```
   npm install -g pm2
   ```
2. أوقف تشغيل تطبيق Node.js من cPanel
3. استخدم PM2 لتشغيل التطبيق:
   ```
   pm2 start ecosystem.config.js
   ```
4. تحقق من حالة التطبيق:
   ```
   pm2 status
   ```
5. تحقق من السجلات:
   ```
   pm2 logs jaberco
   ```

## الخطوة 6: التحقق من السجلات

إذا استمرت المشكلة، تحقق من السجلات:

1. سجلات PM2:
   ```
   cat logs/error.log
   cat logs/out.log
   ```
2. سجل الوسيط:
   ```
   cat logs/proxy.log
   ```
3. سجل تشخيص قاعدة البيانات:
   ```
   cat logs/db-test-result.json
   ```
4. سجلات Apache/Nginx في cPanel (اطلب من مزود الاستضافة الوصول إليها)

## نصائح إضافية

1. **مشكلة الملفات الثابتة**: تأكد من أن الملفات الثابتة (HTML/CSS/JS) موجودة في المجلد `dist/public`
2. **مشكلة CORS**: إذا واجهت مشاكل CORS، تحقق من رؤوس الاستجابة في ملف .htaccess
3. **مشكلة المسارات**: تأكد من استخدام مسارات نسبية وليست مطلقة في التطبيق
4. **مشكلة الأذونات**: قم بضبط الأذونات المناسبة:
   ```
   chmod -R 755 .
   chmod -R 644 ./*.json
   chmod -R 644 ./*.js
   chmod -R 644 ./*.ts
   chmod 755 ./dist
   chmod 755 ./dist/public
   ```

## ما يجب تجنبه

1. **تجنب تعديل الملفات المصدرية**: قم دائماً بإجراء تعديلات على النسخة المحلية ثم إعادة بناء التطبيق ونشره
2. **تجنب استخدام `npm run dev`**: استخدم دائماً وضع الإنتاج على cPanel
3. **تجنب الوصول المباشر إلى قاعدة البيانات**: استخدم دائماً واجهة برمجة التطبيقات (API) للوصول إلى البيانات

إذا استمرت المشكلة بعد اتباع هذه الخطوات، يرجى التواصل مع فريق الدعم الفني الخاص بمزود استضافة cPanel للمساعدة.