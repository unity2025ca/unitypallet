# دليل نقل البيانات من قاعدة البيانات القديمة
## Database Migration Guide

هذا الدليل يشرح كيفية استخدام سكريبت نقل البيانات لتحويل جميع البيانات من قاعدة البيانات القديمة إلى النظام الجديد.

## المتطلبات

1. **قاعدة البيانات القديمة**: يجب أن تكون قاعدة PostgreSQL قابلة للوصول
2. **صلاحيات القراءة**: حساب قاعدة البيانات يجب أن يملك صلاحيات القراءة من جميع الجداول
3. **مساحة تخزين**: مساحة كافية لحفظ ملفات التصدير

## الخطوات

### الخطوة 1: تحديد رابط قاعدة البيانات القديمة

```bash
# طريقة 1: استخدام متغير البيئة الحالي
export DATABASE_URL="postgresql://username:password@hostname:port/database_name"

# طريقة 2: استخدام متغير منفصل لقاعدة البيانات القديمة
export OLD_DATABASE_URL="postgresql://username:password@hostname:port/old_database_name"
```

### الخطوة 2: تشغيل سكريبت النقل

```bash
# تشغيل السكريبت
node run-migration.js
```

## ما يقوم به السكريبت

### 1. فحص الجداول الموجودة
- يتصل بقاعدة البيانات ويفحص جميع الجداول المتاحة
- يعرض قائمة بالجداول الموجودة في قاعدة البيانات

### 2. إنشاء الجداول المفقودة
- ينشئ أي جداول مطلوبة غير موجودة في قاعدة البيانات
- يستخدم هيكل الجداول المحدد مسبقاً

### 3. استخراج البيانات
يستخرج البيانات من الجداول التالية:
- `users` - بيانات المستخدمين
- `products` - بيانات المنتجات
- `categories` - فئات المنتجات
- `product_images` - صور المنتجات
- `settings` - إعدادات الموقع
- `contacts` - رسائل التواصل
- `faqs` - الأسئلة الشائعة
- `appointments` - المواعيد
- `subscribers` - المشتركين في النشرة الإخبارية
- `orders` - الطلبات
- `order_items` - عناصر الطلبات
- `shipping_zones` - مناطق الشحن
- `shipping_rates` - أسعار الشحن
- `locations` - المواقع والمدن
- `allowed_cities` - المدن المسموحة
- `carts` - عربات التسوق
- `cart_items` - عناصر عربة التسوق
- `visitor_stats` - إحصائيات الزوار
- `notifications` - الإشعارات

### 4. حفظ البيانات
ينشئ السكريبت الملفات التالية في مجلد `exported_data`:

#### ملفات JSON
- `complete_database_export.json` - جميع البيانات في ملف واحد
- `[table_name].json` - ملف منفصل لكل جدول يحتوي على بيانات

#### ملف SQL
- `import_script.sql` - سكريبت SQL جاهز لاستيراد البيانات

#### تقرير التصدير
- `export_report.json` - تقرير تفصيلي عن عملية التصدير

## مثال على التقرير

```json
{
  "exportDate": "2024-01-15T10:30:00.000Z",
  "totalTables": 20,
  "existingTables": 18,
  "exportedTables": 15,
  "totalRecords": 1250,
  "tableDetails": {
    "users": {
      "recordCount": 45,
      "status": "exported"
    },
    "products": {
      "recordCount": 125,
      "status": "exported"
    }
  }
}
```

## استخدام البيانات المصدرة

### استيراد باستخدام SQL
```bash
# استيراد البيانات باستخدام سكريبت SQL
psql -h hostname -U username -d database_name -f exported_data/import_script.sql
```

### استخدام ملفات JSON
يمكن استخدام ملفات JSON لاستيراد البيانات برمجياً أو لتحليل البيانات.

## رسائل السكريبت

### رسائل النجاح
- `✅ تمت عملية نقل البيانات بنجاح!`
- `📤 استخراج X سجل من جدول Y`
- `📋 إنشاء جدول: table_name`

### رسائل التحذير
- `⚠️ لا يمكن استخراج البيانات من جدول X`
- `📋 جدول X موجود مسبقاً`

### رسائل الخطأ
- `❌ خطأ في فحص الجداول`
- `❌ خطأ في إنشاء الجداول`
- `❌ خطأ في عملية نقل البيانات`

## استكشاف الأخطاء

### خطأ في الاتصال بقاعدة البيانات
```
❌ خطأ: يجب تعيين متغير DATABASE_URL أو OLD_DATABASE_URL
```
**الحل**: تأكد من تعيين رابط قاعدة البيانات بشكل صحيح

### خطأ في صلاحيات الوصول
```
❌ خطأ: permission denied for table "table_name"
```
**الحل**: تأكد من أن المستخدم يملك صلاحيات القراءة من الجدول

### جدول غير موجود
```
⚠️ لا يمكن استخراج البيانات من جدول table_name: relation "table_name" does not exist
```
**الحل**: هذا تحذير طبيعي إذا لم يكن الجدول موجود في قاعدة البيانات القديمة

## ملاحظات مهمة

1. **النسخ الاحتياطي**: تأكد من أخذ نسخة احتياطية من قاعدة البيانات قبل تشغيل السكريبت
2. **المساحة**: تأكد من وجود مساحة كافية لحفظ ملفات التصدير
3. **الصلاحيات**: المستخدم يحتاج صلاحيات القراءة فقط من قاعدة البيانات القديمة
4. **الأمان**: لا تشارك ملفات التصدير إذا كانت تحتوي على بيانات حساسة

## الدعم الفني

إذا واجهت أي مشاكل في استخدام السكريبت، تأكد من:
- صحة رابط قاعدة البيانات
- صلاحيات المستخدم
- إمكانية الوصول لقاعدة البيانات
- توفر Node.js والمكتبات المطلوبة